<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Construction Danger</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />

  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
    }

    #map {
      width: 100vw;
      height: 100vh;
    }

    .title {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: black;
      color: white;
      padding: 8px 16px;
      border-radius: 6px;
      z-index: 1000;
    }

    .report-btn {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 20px;
      font-size: 16px;
      border: none;
      border-radius: 8px;
      background: black;
      color: white;
      cursor: pointer;
      z-index: 1000;
    }

    #severity {
      position: absolute;
      bottom: 70px;
      left: 50%;
      transform: translateX(-50%);
      padding: 8px;
      border-radius: 6px;
      z-index: 1000;
    }
  </style>
</head>

<body>
  <div class="title">ðŸš§ Construction Danger</div>
  <div id="map"></div>

  <select id="severity">
    <option value="low">ðŸŸ¢ Low</option>
    <option value="medium">ðŸŸ¡ Medium</option>
    <option value="high">ðŸ”´ High</option>
  </select>

  <button class="report-btn" onclick="reportConstruction()">
    ðŸš§ Report Construction
  </button>

  <!-- Scripts -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    // ðŸ”¥ Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyAL-zIzjfQCjmQ1L48EFYtld3pmUxOq3Zk",
      authDomain: "construction-danger.firebaseapp.com",
      projectId: "construction-danger",
      storageBucket: "construction-danger.firebasestorage.app",
      messagingSenderId: "384364130725",
      appId: "1:384364130725:web:61838b4d1ffceeaac8384c"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let map;
    let selectedLatLng = null;
    let markers = {};
    let lastReportTime = 0;

    const colors = {
      low: "green",
      medium: "orange",
      high: "red"
    };

    // ðŸ“ User Location
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        const { latitude, longitude } = pos.coords;

        map = L.map("map").setView([latitude, longitude], 14);

        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          maxZoom: 19,
          attribution: "Â© OpenStreetMap contributors"
        }).addTo(map);

        L.marker([latitude, longitude])
          .addTo(map)
          .bindPopup("You are here");

        map.on("click", (e) => {
          selectedLatLng = e.latlng;
          L.popup()
            .setLatLng(e.latlng)
            .setContent("ðŸ“ Danger location selected")
            .openOn(map);
        });

        startRealtime();
      },
      () => alert("Location access denied")
    );

    // âž• Report
    function reportConstruction() {
      if (!selectedLatLng) {
        alert("Tap on map to select danger");
        return;
      }

      if (Date.now() - lastReportTime < 60000) {
        alert("Wait 1 minute before reporting again");
        return;
      }

      lastReportTime = Date.now();

      const severity = document.getElementById("severity").value;

      db.collection("reports").add({
        lat: selectedLatLng.lat,
        lng: selectedLatLng.lng,
        severity,
        expiresAt: Date.now() + 45 * 60 * 1000
      });

      selectedLatLng = null;
    }

    // ðŸ”„ REALTIME (refresh-proof)
    function startRealtime() {
      db.collection("reports").onSnapshot((snapshot) => {
        snapshot.docChanges().forEach((change) => {
          const id = change.doc.id;
          const data = change.doc.data();

          if (change.type === "removed") {
            removeMarker(id);
            return;
          }

          if (Date.now() > data.expiresAt) {
            removeMarker(id);
            return;
          }

          addMarker(id, data);
        });
      });
    }

    function addMarker(id, data) {
      if (markers[id]) return;

      const marker = L.circleMarker([data.lat, data.lng], {
        radius: 10,
        color: colors[data.severity],
        fillColor: colors[data.severity],
        fillOpacity: 0.8
      })
        .addTo(map)
        .bindPopup(`ðŸš§ Construction (${data.severity.toUpperCase()})`);

      marker.expiresAt = data.expiresAt;
      markers[id] = marker;
    }

    function removeMarker(id) {
      if (markers[id]) {
        map.removeLayer(markers[id]);
        delete markers[id];
      }
    }

    // ðŸ§¹ Client cleanup (visual only)
    setInterval(() => {
      const now = Date.now();
      Object.keys(markers).forEach((id) => {
        if (markers[id].expiresAt < now) {
          removeMarker(id);
        }
      });
    }, 60000);
  </script>
</body>
</html>
